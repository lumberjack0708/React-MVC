# 更新日誌

本檔案記錄了此專案所有重要的變更。

格式基於 [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)，
並且專案遵循語義化版本控制 ([Semantic Versioning](https://semver.org/spec/v2.0.0.html))。

## [3.5.0] - 2025-06-19
### changed
- 修正了原本admin身分可以看到【一般身分】購物頁面的問題，在這個版本中當 `role_id === 1` 時會顯示完全不同的畫面並重新導航到 `/admin/products`；使其更符合實際的電商網站邏輯

### improved
- 優化原先admin介面會有無意義滾動的問題，適當的調整了`AdminLayout`、訂單管理與商品管理的 table  `padding` 參數，讓無意義滾動的問題被解決
- 將分頁器從AntDesign Table中獨立，從根源上避免因資料筆數不同導致分頁器跟著上下跑的問題
- **分頁性能優化** - 在訂單管理和商品管理中實現 `useMemo` 優化分頁計算
  - 新增 `paginatedOrders` 和 `paginatedProducts` 計算屬性，避免每次重新渲染時都重新執行 `slice()` 操作
  - 智能依賴陣列設計：僅在資料變更、翻頁或調整頁面大小時才重新計算
  - 大幅提升大量資料情況下的分頁切換流暢度和整體性能表現

## [3.4.0] - 2025-06-18
### changed
- 這個版本修正了過去幾個版本嚴重的框架問題，將所有 `Model` 層中的商業邏輯都移到 `Controller`


## [3.3.0] - 2025-06-15
### added
- 這個版本把上個版本的todo填上了，新增了`getAllProducts`這支API，店家可以查詢所有商品，而顧客端只會查詢 `p_state='active'` 的商品，並新增了這支API的權限僅為admin擁有
- 在前端顯示與更改畫面添加 `p_state` 顯示，並設置`width`參數為10%

## [3.2.3] - 2025-06-15
這個版本和前一個版本沒有任何不同，但我想到了一個todo；另外就是這個版本為了從桌機改到筆電run，因此重新執行了composer install
### todo
- 產品的移除可以改用「下架狀態（Discontinue）」取代，在Product資料表新增 `p_status` 欄位用來管理商品狀態，購買過的商品仍然在訂單顯示，但是商城內只會顯示狀態為【上架中】的商品

## [3.2.2] - 2025-06-14
### Improved
- 優化移除產品的錯誤處理，原先的產品移除時只有簡單的錯誤驗證；但在遇到需要刪除訂單有使用到的索引商品時會出現無法刪除的情況發生，因此在這個版本新增了後端邏輯還有前端useContext來顯示這部分的邏輯

## [3.2.1] - 2025-06-13
### Enhanced
- **Redux 與後端 API 完整整合** - 實現統一的購物車狀態管理
  - 重構 `cartSlice.js` 新增 `fetchCartStatistics` async thunk，直接從後端 API 獲取購物車統計
  - 升級 Redux Store 架構：新增 `statistics`、`loading`、`error` 狀態管理
  - 實現智慧選擇器：優先使用後端統計資料，fallback 到本地計算確保穩定性
  - 新增 `extraReducers` 處理異步操作的完整生命週期（pending/fulfilled/rejected）

### Changed
- **App.js 購物車徽章重構** - 從 CartBadge 組件改回 Redux 驅動
  - 恢復 `useSelector(selectCartItemCount)` 使用 Redux 管理購物車數量顯示
  - 整合 `useDispatch` 在關鍵節點自動刷新購物車統計
  - 登入成功時立即載入用戶購物車統計資料
  - 登出時自動清空購物車統計，避免數據洩露
  - 新增定期刷新機制：每30秒自動從後端同步最新購物車數據

### Fixed
- **購物車數量同步問題** - 解決徽章不顯示實際數量的問題
  - 修正 `HomePage.js` 和 `ProductsPage.js` 加入購物車成功後立即刷新 Redux 統計
  - 修正 `CartPage.js` 所有購物車操作（數量修改、商品移除、清空購物車、結帳）後自動刷新 Redux
  - 確保所有購物車相關操作都會觸發徽章即時更新
  - 修正跨頁面購物車狀態同步問題

### Technical
- **異步狀態管理優化** - 完整的 loading 和錯誤處理機制
  - 實現 Redux Toolkit 的 `createAsyncThunk` 最佳實踐
  - 新增購物車統計載入狀態指示器
  - 建立完整的錯誤處理和回退機制
  - 統一所有購物車操作的狀態管理流程

### Architecture
- **混合式狀態管理策略** - 結合 Redux 全域管理與 API 驅動設計
  - Redux 負責購物車徽章的全域狀態管理和跨組件同步
  - CartService 負責具體的 API 操作和業務邏輯處理
  - 實現最佳的用戶體驗：即時 UI 更新 + 後端數據準確性保證
  - 建立可擴展的狀態管理模式，支援未來功能擴展


## [3.2.0] - 2025-06-13
### Added
- **完整使用者註冊系統** - 實現企業級前後端註冊功能
  - 新增 `RegisterModal.js` 註冊模態視窗組件 (239 行)，包含 7 個表單欄位：帳號、密碼、確認密碼、姓名、email、地址、生日
  - 新增後端 `newUser` API 註冊功能，支援多階段處理：帳號驗證 → 角色分配 → 購物車初始化 → 完整性檢查
  - 實現 dayjs 日期處理整合，精確管理生日欄位格式化與驗證
  - 建立完整的前後端資料驗證一致性：帳號格式 (3-10 字母數字)、email 格式、密碼強度 (6+ 字元)
  - 新增智慧化表單管理：自動聚焦、Tab 鍵順序、表單記憶功能
  - 建立雙重通知系統：全域 notify + Ant Design message，提供個人化成功訊息

### Changed
- **使用者認證流程優化** - 無縫整合註冊與登入體驗
  - 重構 `LoginModal.js` 實現註冊/登入模式切換，無需額外頁面導航
  - 優化父子組件通信模式，統一 `onLoginSuccess` 回調處理
  - 改進表單狀態管理，註冊成功後自動填入登入表單
  - 升級錯誤處理機制，提供具體指導性錯誤訊息

### Enhanced
- **後端業務邏輯強化** - 企業級資料完整性保障
  - 實現手動事務回滾機制：註冊失敗時自動清理 account、user_role、shopping_cart 記錄
  - 建立多層級安全驗證：SQL 注入防護、密碼處理安全、帳號重複檢查
  - 優化資料庫操作：自動角色分配 (role_id=2)、購物車初始化、完整性驗證
  - 加強錯誤記錄與監控機制，支援問題追蹤與除錯

### Security
- **註冊安全性提升** - 多層防護機制
  - 實現前後端雙重驗證：客戶端即時驗證 + 伺服器端安全檢查
  - 建立 SQL 注入防護：預處理語句 + 參數綁定
  - 加強密碼安全處理：最小長度要求 + 格式驗證
  - 實現資料完整性檢查：跨資料表一致性驗證


## [3.1.0] - 2025-06-12
### Added
- **前端購物車功能完整實現** - 將後端購物車 API 完全整合至前端系統
  - 新增 `cartService.js` 服務層，封裝所有購物車 API 調用，統一錯誤處理和參數格式化
  - 創建 `CartBadge.js` 購物車數量徽章組件，實時顯示購物車商品數量
  - 重構 `CartPage.js` 購物車頁面，移除 Redux 依賴，直接使用後端資料
  - 更新 `ProductsPage.js` 和 `HomePage.js` 的加入購物車功能，改用後端 API
  - 升級 `ProductDetailModal.js` 支援 async 操作和錯誤處理
- **樂觀更新 (Optimistic Updates)** - 詳見 `optimistic_updates.md`
  - 用戶操作立即反應 UI 變化，背景發送請求
  - 請求失敗時自動回滾至原始狀態
  - 大幅提升用戶體驗，消除操作延遲感
  - 支援數量修改、商品移除、清空購物車等所有操作
- **即時庫存驗證** - 加入購物車前檢查商品庫存，防止超賣
- **價格變動提醒** - 顯示商品價格異動，保障消費者權益
- **完整結帳流程** - 從購物車直接進入訂單建立流程

### Changed
- 移除 `ProductsPage.js` 和 `HomePage.js` 中的全域 `actionLoading` 狀態
- 購物車頁面改用獨立的 `checkoutLoading` 狀態管理結帳流程
- 優化 InputNumber 組件顯示，移除內建加減按鈕避免重複，設置文字居中

### Fixed
- 修正 `cartItems.map is not a function` 錯誤，適配後端 `{items: [...], statistics: {...}}` 資料格式
- 修正樂觀更新實現後的狀態同步問題
- 修正購物車商品數量更新的邊界值檢查
- 解決瀏覽器熱更新導致的 `actionLoading is not defined` 錯誤


## [3.0.0] - 2025-06-12
### added
- 專案迎來重磅史詩級加強，加入購物車資料表寫入資料至後端，並新增六種API，已完成前後端整合，如下：


  **1. `getCart` - 獲取購物車**
  - 驗證用戶身份
  - 查詢用戶的活躍購物車
  - 如果沒有購物車，自動創建一個
  - 返回購物車詳細資訊（包含商品資訊、當前價格對比）
  - 檢查商品庫存狀態

  **2. `addToCart` - 加入購物車**
  - 驗證商品是否存在
  - 檢查商品庫存是否足夠
  - 檢查用戶是否有活躍購物車，沒有則創建
  - 檢查商品是否已在購物車中
    - 如果存在：增加數量
    - 如果不存在：新增商品項目
  - 記錄當前商品價格
  - 驗證總數量不超過庫存

  **3. `updateCartItem` - 更新購物車商品數量**
  - 驗證購物車項目是否屬於該用戶
  - 檢查新數量是否有效（> 0）
  - 驗證庫存是否足夠
  - 更新商品數量
  - 如果數量為 0，則刪除該項目

  **4. `removeFromCart` - 從購物車移除商品**
  - 驗證購物車項目是否屬於該用戶
  - 刪除指定的購物車項目
  - 檢查購物車是否為空
    - 如果為空，可選擇保持購物車或標記為 abandoned

  **5. `clearCart` - 清空購物車**
  - 驗證用戶購物車
  - 刪除所有購物車項目
  - 可選擇刪除購物車或標記狀態為 abandoned
  - 記錄清空時間（用於分析）

  **6. `getCartStatistics` - 獲取購物車統計資訊**
  - 計算商品總數量
  - 計算總金額（使用當前價格和購物車價格）
  - 統計商品種類數
  - 檢查價格變動商品
  - 返回購物車摘要資訊

## [2.2.0] - 2025-06-12
### Fixed
- 修正邏輯錯誤: 店家居然無法刪除訂單
  1. 在前個版本的取消前端中是用`Modal.confirm`來實現，但這樣可能會遇到對話框被 Select 的下拉選單層級遮蓋了，或者存在其他的 z-index 問題(幹其實我也不知道反正我是想說更改狀態跟取消訂單用的是不同API可能會有錯所以就把它分開了 然後就會動了)
  2. 根據前述，我在這個版本改用了`Popconfirm `元件來獨立顯示「取消」這個按鈕
  3. 另外打個岔我有想過乾脆要把它們弄回同一支API，因為在好幾個版本以前我是用同一支API操作取消狀態，都是用`updateOrderStatus`，但是這支API有個嚴重的邏輯漏洞是他沒有庫存回滾的邏輯，所以還是只能乖乖取消訂單的問題qq

## [2.1.0] - 2025-06-12
### Fixed
- 原先的店家訂單管理只有更新狀態API(updateOrderStatus)，卻沒有取消訂單API，在此版本修復了這個問題

## [2.0.0] - 2025-06-10
### 新增
- JWT&Token登入機制，串接前後端，並將Token時效設定為一小時
- 【購買紀錄】防呆機制，新增Token過期時的防呆機制，從根源上避免Token過期的時候會狂刷錯誤的問題
- 新增`Account.php`、`Order.php`、`Product.php`等檔案的權限控管至`Action.php`、`AuthMIddleware.php`、`main.php`
  
### Todo
- Token過期後購買紀錄沒有相對應的頁面顯示，而是不斷跳錯誤訊息，很醜!

### Fixed
- 修正前幾個版本登入之後所有頁面皆無法正常使用的問題，是因為在`backend/routes/web.php`檔案中註冊了錯誤的路由(不屬於中介層的路由)，而這些`include_once`語句會這些程式碼，進而產生錯誤
- 修改 `ProductForm.js` 將 `name` 改為 `p_name`，解決無法正常新增/刪除商品的問題
- 修正原先兩個身分都無法訪問`action=getUser`的問題，原因是因為原先的做法是透過傳入參數給`action=getUsers`來進入`getUser()`，但這樣的方法會因為一般使用者無法訪問`action=getUsers`的原因而被擋下
- 修正邏輯錯誤: 未登入的人按下【加入購物車】後會被擋下來
  1.  阻止加入購物車 
  2.  顯示警告訊息 - 使用 `notify.warning` 提示用戶需要先登入
  3.  自動彈出登入視窗呼叫`onLoginRequest()`(`Homepage.js`、`ProductsPage.js`)
- 修正產品詳情模態視窗(`ProductDetailModal.js`)的圖片顯示問題，原本的路徑現在已不存在，更新為新的`API_CONFIG`配置

### Changed
- 將原本全域可見的右上角店家管理按鈕更新為`user?.role_id === 1`才可見，並且在`App.js`的路由設定中設有一樣的邏輯閥確定只有Admin身分可以訪問
- 將`action=getProducts`改為開放權限，未登入也可以訪問
- 將`Style.js`中的`ProductImage`樣式元件移除滑鼠懸停圖片放大效果，避免懸停時會截斷商品卡陰影的情況發生


## [1.1.0] - 2025-06-07

### 新增
- 訂單管理相關路由與 CORS 設定 (5fe176b, cc63e07)
- 產品管理與圖片上傳功能 (a993c59, b2c735a)
- 顯示庫存量於商品卡片 (81c33eb)
- 訂單統計與購買紀錄頁面 (fe9d82e)
- 購物車串接 newOrder API (1b2184f)

### 修改
- 將 User 控制器與模型改為 Account 類別並調整路由 (cc63e07)
- 更新多個頁面樣式 (bc27608)
- 調整訂單詳情查詢邏輯 (0f3a91e)
- 更新 README 說明 (102f0ba)

### 已移除
- 移除不再使用的 SQL 檔案及相關註解 (5fe176b, 18bce45)
- 刪除 User 控制器與模型 (cc63e07)

### 已修正
- 修正 menu z-index 排序問題 (3f1a0dc)
- 修正新增產品圖片載入問題 (f78db3a, 39c1e32)
- 修正 HomePage 樣式匯入路徑 (a6b5ca1)
- 修正後台警告 (e195589)

## [1.0.0] - 2025-06-05

### 新增
- **後端**商品CRUD功能呼叫完善(店家身分)、檢視商品(無須登入)
- **後端**帳戶資料更改功能完善(所有已登入身分)

### todo 
- 商品購買、歷史紀錄後端
- 訂單管理後端功能實現



## [模板]

### 新增 (Added)
- (此處記錄即將發佈版本的新功能)
- 例如：使用者個人資料頁面。

### 修改 (Changed)
- (此處記錄即將發佈版本中現有功能的變更)
- 例如：更新了登入頁面的使用者介面。

### 已棄用 (Deprecated)
- (此處記錄即將發佈版本中將被移除的舊功能)

### 已移除 (Removed)
- (此處記錄即將發佈版本中已被移除的功能)

### 已修正 (Fixed)
- (此處記錄即將發佈版本中的錯誤修復)
- 例如：修正了特定情況下產品無法加入購物車的問題。

### 安全性 (Security)
- (此處記錄即將發佈版本中與安全性相關的改進